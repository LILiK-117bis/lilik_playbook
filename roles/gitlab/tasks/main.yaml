# see /usr/share/doc/gitlab/README.Debian.gz
# for instruction on how to migrate and reset root password

- name: 'install gnupg and ca-cert'
  apt:
    pkg:
      - 'gnupg'
      - 'ca-certificates'
  tags:
    - 'packages'

- name: 'add gitlab gnupg key to apt'
  apt_key:
    id: 'F6403F6544A38863DAA0B6E03F01618A51312F3F'
    url: 'https://packages.gitlab.com/gpg.key'
    state: 'present'
  tags:
    - 'packages'

- name: 'add gitlab apt repos'
  apt_repository:
    repo: '{{ item }}'
    state: 'present'
  loop:
    - 'deb https://packages.gitlab.com/gitlab/gitlab-ce/debian/ buster main'
    - 'deb-src https://packages.gitlab.com/gitlab/gitlab-ce/debian/ buster main'
  tags:
    - 'packages'

- name: 'install gitlab'
  apt:
    pkg: 'gitlab-ce'
    state: 'present'
    update_cache: true
    cache_valid_time: 3600
  tags:
    - 'packages'

- name: 'load root ca'
  copy:
    content: '{{ tls_root_ca }}'
    dest: '/etc/gitlab/root_ca.crt'
  tags:
    - 'tls_int'

- name: 'generate gitlab ldap password'
  gen_passwd: 'length=32'
  register: 'new_passwd'
  tags:
    - 'tls_int'
    - 'service_password'

- name: 'set gitlab ldap password'
  delegate_to: 'localhost'
  ldap_passwd:
    dn: 'cn={{ ansible_hostname }},ou=Server,{{ ldap_basedn }}'
    passwd: '{{ new_passwd.passwd }}'
    server_uri: 'ldap://{{ ldap_server }}'
    start_tls: true
    bind_dn: '{{ ldap_admin_dn }}'
    bind_pw: '{{ ldap_admin_pw }}'
  tags:
    - 'tls_int'
    - 'service_password'

- name: 'update gitlab configuration'
  template:
      src: 'gitlab.rb.j2'
      dest: '/etc/gitlab/gitlab.rb'
  notify: 'reconfigure gitlab'
  tags:
    - 'tls_int'
    - 'service_password'

- name: 'patch gitlab to run in lxc'
  lineinfile:
    path: '/opt/gitlab/embedded/cookbooks/package/resources/gitlab_sysctl.rb'
    insertafter: '^    command "sysctl -e --system"\n'
    line: '    ignore_failure true'
  notify: 'reconfigure gitlab'
