server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    {% if proxy_protocol %}
    # Alternate Port for PROXY PROTOCOL incoming connections
    listen 10443 ssl http2 proxy_protocol;
    listen [::]:10443 ssl http2 proxy_protocol;

    # RealIP rewrite authorized for connection from reverse-proxy
    set_real_ip_from {{ hostvars | ip_from_inventory('vm_gateway') }};
    real_ip_header proxy_protocol;
    {% endif %}


    ssl_certificate /etc/letsencrypt/live/{{ server_fqdn }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ server_fqdn }}/privkey.pem;

    ssl_session_timeout 5m;
    ssl_session_cache shared:MozSSL:10m;
    ssl_session_tickets off;

    ssl_protocols TLSv1.3;
    ssl_prefer_server_ciphers off;

    ssl_stapling on;
    ssl_stapling_verify on;

    add_header Strict-Transport-Security "max-age=63072000" always;

    ssl_trusted_certificate /etc/letsencrypt/live/{{ server_fqdn }}/chain.pem;

    include     /etc/nginx/locations/{{ server_fqdn }}/*.conf;
}
